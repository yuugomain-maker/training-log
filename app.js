# ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚° Web ã‚¢ãƒ—ãƒªï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‹è…¹ï¼†æœ‰é…¸ç´ ï¼‹ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¨®ç›®è¿½åŠ ç‰ˆï¼‰

---

## index.html

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚°</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }

    body {
      margin: 0;
      padding: 0;
      background: #111827;
      color: #e5e7eb;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #22c55e, #06b6d4, #a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    section {
      background: #020617;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      margin-bottom: 8px;
    }

    section h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 8px;
    }

    form label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    input[type="date"],
    input[type="number"],
    input[type="text"],
    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: inherit;
      font-size: 0.9rem;
    }

    select option {
      background-color: #020617;
      color: #e5e7eb;
    }

    input::placeholder {
      color: #6b7280;
    }

    .date-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 8px;
    }

    .date-row label {
      flex: 1;
      margin-bottom: 0;
    }

    .custom-ex-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .custom-ex-input {
      flex: 1;
    }

    .body-part-row {
      margin: 8px 0;
    }

    .body-part-label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .body-part-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .body-part-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .body-part-btn.active {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
    }

    button[type="submit"] {
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      background: #22c55e;
      color: #022c22;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background 0.1s ease-out;
    }

    button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.35);
      background: #4ade80;
    }

    button[type="submit"]:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-secondary {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-secondary:hover {
      background: #0b1120;
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .button-row button[type="submit"] {
      flex: 1;
    }

    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    #log-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 320px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    #log-list li {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #020617;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    #log-list li:hover {
      background: #0b1120;
    }

    .log-main-text {
      flex: 1;
    }

    .log-delete-hint {
      font-size: 0.7rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .chart-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.85rem;
    }

    .chart-controls select {
      min-width: 140px;
    }

    canvas {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #111827;
    }

    #stats p {
      margin: 4px 0;
      font-size: 0.9rem;
    }

    #history h3 {
      margin-bottom: 4px;
      margin-top: 8px;
      font-size: 0.95rem;
    }

    #history ul {
      margin: 0 0 4px 1rem;
      padding-left: 0;
      font-size: 0.85rem;
    }

    #history li {
      margin-bottom: 2px;
    }

    #history p {
      margin: 0 0 4px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    #date-session-summary {
      font-size: 0.85rem;
      margin-top: 4px;
    }

    #date-session-summary h3 {
      font-size: 0.95rem;
      margin: 8px 0 4px;
    }

    #date-session-summary ul {
      margin: 0 0 4px 1rem;
      padding-left: 0;
      font-size: 0.85rem;
    }

    #date-session-summary li {
      margin-bottom: 2px;
    }

    /* ç­‹ãƒˆãƒ¬ï¼æœ‰é…¸ç´ ã®åˆ‡ã‚Šæ›¿ãˆç”¨ */
    .strength-field {}
    .cardio-field {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚°</h1>
    </header>

    <main>
      <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  + ç¨®ç›®åˆ¥å±¥æ­´ + ã‚°ãƒ©ãƒ• -->
      <div>
        <section>
          <h2>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
          <form id="log-form">
            <div class="date-row">
              <label>
                æ—¥ä»˜
                <input type="date" id="date" />
              </label>
              <button type="button" id="today-btn" class="btn-secondary">ä»Šæ—¥</button>
            </div>

            <label>
              ä½“é‡ (kg)
              <input type="number" id="bodyWeight" inputmode="decimal" step="0.1" />
            </label>

            <div class="body-part-row">
              <span class="body-part-label">éƒ¨ä½</span>
              <div class="body-part-buttons">
                <button type="button" class="body-part-btn active" data-body-part="èƒ¸">èƒ¸</button>
                <button type="button" class="body-part-btn" data-body-part="è‚©">è‚©</button>
                <button type="button" class="body-part-btn" data-body-part="èƒŒä¸­">èƒŒä¸­</button>
                <button type="button" class="body-part-btn" data-body-part="è„šãƒ»ä¸‹åŠèº«">è„šãƒ»ä¸‹åŠèº«</button>
                <button type="button" class="body-part-btn" data-body-part="è…•">è…•</button>
                <button type="button" class="body-part-btn" data-body-part="è…¹">è…¹</button>
                <button type="button" class="body-part-btn" data-body-part="æœ‰é…¸ç´ ">æœ‰é…¸ç´ </button>
                <button type="button" class="body-part-btn" data-body-part="ãã®ä»–">ãã®ä»–</button>
              </div>
            </div>

            <label>
              ç¨®ç›®
              <select id="exercise">
                <!-- JS å´ã§ç¾åœ¨ã®éƒ¨ä½ã«å¿œã˜ã¦ä¸­èº«ã‚’å·®ã—æ›¿ãˆ -->
              </select>
              <div class="custom-ex-row">
                <input
                  type="text"
                  id="custom-ex-input"
                  class="custom-ex-input"
                  placeholder="æ–°ã—ã„ç¨®ç›®åã‚’å…¥åŠ›"
                />
                <button type="button" id="add-custom-ex-btn" class="btn-secondary">ç¨®ç›®ã‚’è¿½åŠ </button>
              </div>
            </label>

            <!-- â–¼ç­‹ãƒˆãƒ¬ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <label class="strength-field">
              ã‚»ãƒƒãƒˆç•ªå·
              <input type="number" id="setNo" min="1" value="1" />
            </label>

            <label class="strength-field">
              é‡é‡ (kg)
              <input type="number" id="weight" inputmode="decimal" step="0.1" />
            </label>

            <label class="strength-field">
              å›æ•°
              <input type="number" id="reps" inputmode="numeric" />
            </label>

            <label class="strength-field">
              RPE
              <input type="number" id="rpe" step="0.5" min="5" max="10" />
            </label>

            <!-- â–¼æœ‰é…¸ç´ ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <label class="cardio-field">
              è·é›¢ (km)
              <input type="number" id="distance" inputmode="decimal" step="0.01" />
            </label>

            <label class="cardio-field">
              æ™‚é–“ (åˆ†)
              <input type="number" id="duration" inputmode="decimal" step="0.1" />
            </label>

            <label class="cardio-field">
              é€Ÿã• (min/km ãªã©ä»»æ„)
              <input type="text" id="speed" />
            </label>

            <label>
              ãƒ¡ãƒ¢
              <input type="text" id="memo" placeholder="ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ä½“èª¿ãƒ»è£œåŠ©ã‚ã‚Š ãªã©" />
            </label>

            <div class="button-row">
              <button type="submit">ã“ã®ã‚»ãƒƒãƒˆã‚’è¿½åŠ </button>
              <button type="button" id="copy-first-set-btn" class="btn-secondary">1ã‚»ãƒƒãƒˆç›®ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <p class="hint">â€» åŒã˜æ—¥ãƒ»åŒã˜ç¨®ç›®ã®ã¨ãã¯ã€1ã‚»ãƒƒãƒˆç›®ã‚’ç™»éŒ²å¾Œã€Œ1ã‚»ãƒƒãƒˆç›®ã‚’ã‚³ãƒ”ãƒ¼ã€ã§ 2ã€œ4 ã‚»ãƒƒãƒˆç›®ã‚’ç´ æ—©ãè¿½åŠ ã§ãã¾ã™ã€‚</p>
          </form>
        </section>

        <section>
          <h2>ç¨®ç›®åˆ¥å±¥æ­´ï¼ˆæœ€è¿‘ 3 å›ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥ï¼‰</h2>
          <div id="history">ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </section>

        <section>
          <h2>æ¨å®š 1RM ã‚°ãƒ©ãƒ•</h2>
          <div class="chart-controls">
            <label>
              ç¨®ç›®ï¼š
              <select id="exercise-select">
                <option value="">è¨˜éŒ²ãŒã‚ã‚‹ç¨®ç›®ã‹ã‚‰é¸æŠ</option>
              </select>
            </label>

            <label>
              æœŸé–“ï¼š
              <select id="range-select">
                <option value="all">å…¨æœŸé–“</option>
                <option value="30">ç›´è¿‘ 30 æ—¥</option>
                <option value="90">ç›´è¿‘ 90 æ—¥</option>
              </select>
            </label>
          </div>

          <canvas id="rmChart" height="200"></canvas>
        </section>
      </div>

      <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒˆãƒ¬æ—¥åˆ¥ä¸€è¦§ + çµ±è¨ˆ + è¨˜éŒ²ä¸€è¦§ -->
      <div>
        <section>
          <h2>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥åˆ¥ä¸€è¦§</h2>
          <p class="hint">å‰å›ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥ãªã©ã‚’é¸ã¶ã¨ã€ãã®æ—¥ã«è¡Œã£ãŸå…¨ç¨®ç›®ã¨ã‚»ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          <label>
            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥ï¼š
            <select id="date-session-select">
              <option value="">æ—¥ä»˜ã‚’é¸æŠ</option>
            </select>
          </label>
          <div id="date-session-summary"></div>
        </section>

        <section>
          <h2>çµ±è¨ˆ</h2>
          <div id="stats">ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </section>

        <section>
          <h2>è¨˜éŒ²ä¸€è¦§</h2>
          <p class="hint">â€» ä¸€è¦§ã®è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®è¨˜éŒ²ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚</p>
          <ul id="log-list"></ul>
        </section>
      </div>
    </main>
  </div>

  <!-- ã‚°ãƒ©ãƒ•ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script type="module" src="./app.js"></script>
</body>
</html>
```

---

## app.js

```javascript
// ==============================
// Firebase / Firestore èª­ã¿è¾¼ã¿
// ==============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ==============================
// Firebase åˆæœŸåŒ–
// ==============================
const firebaseConfig = {
  apiKey: "AIzaSyDCNOp_Qk__5ClLSVCUwDUU6rtGKAnX2JU",
  authDomain: "training-log-27407.firebaseapp.com",
  projectId: "training-log-27407",
  storageBucket: "training-log-27407.firebasestorage.app",
  messagingSenderId: "996903584995",
  appId: "1:996903584995:web:09e63c9b6447b3952c71d6",
  measurementId: "G-LBHF20MC70",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ==============================
// Google Sheets é€£æºè¨­å®š
// ==============================
const SHEET_WEBHOOK_URL =
  "https://script.google.com/macros/s/AKfycbwwoKPVulUclvzJ19GOTMaQXY1BMKGZtEp7QqPaizhma8clylPSqzlxmPu0KOmP84ISlw/exec";

function sendLogToSheet(log) {
  if (!SHEET_WEBHOOK_URL) {
    console.warn("SHEET_WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  fetch(SHEET_WEBHOOK_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(log),
  })
    .then(() => {
      console.log("ğŸ“„ ã‚·ãƒ¼ãƒˆã¸é€ä¿¡å®Œäº†");
    })
    .catch((err) => {
      console.error("âš  ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãå‡ºã—å¤±æ•—:", err);
    });
}

// ==============================
// å‹æƒ…å ±ï¼ˆJSDocï¼‰
// ==============================
/**
 * @typedef {Object} TrainingLog
 * @property {string} date - YYYY-MM-DD
 * @property {number | null} [bodyWeight]
 * @property {string} exercise
 * @property {number} setNo
 * @property {number} weight
 * @property {number} reps
 * @property {string | null} [rpe]
 * @property {string} [memo]
 * @property {number | null} [distance]
 * @property {number | null} [duration]
 * @property {string | null} [speed]
 */

/**
 * @typedef {Object} ExerciseSession
 * @property {string} date
 * @property {TrainingLog[]} sets
 * @property {TrainingLog} topSet
 * @property {number} top1RM
 * @property {number} volume
 */

// ==============================
// ç¨®ç›®ãƒã‚¹ã‚¿ï¼ˆã‚«ãƒ†ã‚´ãƒªã”ã¨ï¼‰
// ==============================
const BODY_PARTS = ["èƒ¸", "è‚©", "èƒŒä¸­", "è„šãƒ»ä¸‹åŠèº«", "è…•", "è…¹", "æœ‰é…¸ç´ ", "ãã®ä»–"];

const DEFAULT_EXERCISES = {
  èƒ¸: ["ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹", "ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹", "ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ã‚¹"],
  è‚©: ["ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãƒ—ãƒ¬ã‚¹", "ãƒ€ãƒ³ãƒ™ãƒ«ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹", "ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º"],
  èƒŒä¸­: ["ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³", "ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ã‚¦", "ãƒ­ãƒ¼ãƒ­ã‚¦", "ãƒªã‚¢ãƒ‡ãƒ«ãƒˆãƒ•ãƒ©ã‚¤"],
  "è„šãƒ»ä¸‹åŠèº«": [
    "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ",
    "ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ",
    "ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ",
    "ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹",
    "ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«",
    "ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³",
  ],
  è…•: ["ã‚±ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ«", "ãƒãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ«", "ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³"],
  è…¹: ["ã‚±ãƒ¼ãƒ–ãƒ«ã‚¯ãƒ©ãƒ³ãƒ", "ã‚¢ãƒ–ãƒ­ãƒ¼ãƒ©ãƒ¼"],
  æœ‰é…¸ç´ : ["ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "ãƒã‚¤ã‚¯"],
  ãã®ä»–: ["ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ãƒˆãƒ«ã‚½ãƒ¼"],
};

const CARDIO_BODY_PART = "æœ‰é…¸ç´ ";

// ==============================
// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é–¢é€£
// ==============================
const STORAGE_KEY = "trainingLog_v3";
const CUSTOM_EXERCISE_KEY = "trainingCustomExercises_v3";

function loadRecords() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(parsed)) return [];
    return parsed;
  } catch (e) {
    console.warn("loadRecords failed:", e);
    return [];
  }
}

function saveLogsToLocal(logs) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
  } catch (e) {
    console.error("saveLogsToLocal failed:", e);
  }
}

/** @typedef {{ name: string; bodyPart: string }} CustomExercise */

function loadCustomExercises() {
  try {
    const raw = localStorage.getItem(CUSTOM_EXERCISE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch (e) {
    console.warn("loadCustomExercises failed:", e);
    return [];
  }
}

function saveCustomExercises(list) {
  try {
    localStorage.setItem(CUSTOM_EXERCISE_KEY, JSON.stringify(list));
  } catch (e) {
    console.error("saveCustomExercises failed:", e);
  }
}

function getCustomExercisesFor(bodyPart) {
  const all = loadCustomExercises();
  return all.filter((c) => c.bodyPart === bodyPart).map((c) => c.name);
}

function getAllExerciseNames() {
  const set = new Set();
  BODY_PARTS.forEach((bp) => {
    (DEFAULT_EXERCISES[bp] || []).forEach((name) => set.add(name));
  });
  loadCustomExercises().forEach((c) => set.add(c.name));
  return Array.from(set);
}

function getCardioExerciseNames() {
  const defaults = DEFAULT_EXERCISES[CARDIO_BODY_PART] || [];
  const customs = getCustomExercisesFor(CARDIO_BODY_PART);
  return [...defaults, ...customs];
}

function isCardioExercise(exerciseName) {
  return getCardioExerciseNames().includes(exerciseName);
}

// ==============================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ==============================
function estimate1RM(weight, reps) {
  if (!weight || !reps) return null;
  const rm = weight * (1 + reps / 30);
  return Math.round(rm * 10) / 10;
}

function isWithinRange(dateStr, rangeValue) {
  if (!dateStr) return false;
  if (rangeValue === "all") return true;

  const days = parseInt(rangeValue, 10);
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return false;

  const today = new Date();
  const diffMs = today - d;
  const diffDays = diffMs / (1000 * 60 * 60 * 24);
  return diffDays <= days;
}

function getExerciseSessions(exerciseName, rangeValue) {
  // æœ‰é…¸ç´ ã¯ 1RM ã‚°ãƒ©ãƒ•ãƒ»çµ±è¨ˆã®å¯¾è±¡å¤–
  if (isCardioExercise(exerciseName)) return [];

  const filteredLogs = logs.filter(
    (log) => log.exercise === exerciseName && isWithinRange(log.date, rangeValue),
  );

  if (filteredLogs.length === 0) return [];

  const map = /** @type {Record<string, TrainingLog[]>} */ ({});
  filteredLogs.forEach((log) => {
    if (!map[log.date]) map[log.date] = [];
    map[log.date].push(log);
  });

  const dates = Object.keys(map).sort();

  return dates.map((date) => {
    const sets = map[date]
      .slice()
      .sort((a, b) => (a.setNo || 0) - (b.setNo || 0));

    let topSet = sets[0];
    sets.forEach((s) => {
      if (
        s.weight > topSet.weight ||
        (s.weight === topSet.weight && s.reps > topSet.reps)
      ) {
        topSet = s;
      }
    });

    const top1RM = estimate1RM(topSet.weight, topSet.reps) ?? 0;
    const volume = sets.reduce((sum, s) => sum + s.weight * s.reps, 0);

    return { date, sets, topSet, top1RM, volume };
  });
}

function getTodayString() {
  const today = new Date();
  return today.toISOString().slice(0, 10);
}

function setDefaultDate() {
  const dateInput = /** @type {HTMLInputElement | null} */ (
    document.getElementById("date")
  );
  if (!dateInput) return;
  if (!dateInput.value) {
    dateInput.value = getTodayString();
  }
}

// ==============================
// DOM è¦ç´ 
// ==============================
const form = document.getElementById("log-form");
const list = document.getElementById("log-list");
const exerciseSelectForGraph = document.getElementById("exercise-select");
const rangeSelect = document.getElementById("range-select");
const historyDiv = document.getElementById("history");
const statsDiv = document.getElementById("stats");
const todayBtn = document.getElementById("today-btn");
const copyFirstSetBtn = document.getElementById("copy-first-set-btn");
const dateSessionSelect = document.getElementById("date-session-select");
const dateSessionSummary = document.getElementById("date-session-summary");
const exerciseSelect = document.getElementById("exercise");
const customExInput = document.getElementById("custom-ex-input");
const addCustomExBtn = document.getElementById("add-custom-ex-btn");
const bodyPartButtons = document.querySelectorAll(".body-part-btn");
const strengthFields = document.querySelectorAll(".strength-field");
const cardioFields = document.querySelectorAll(".cardio-field");

let currentBodyPart = "èƒ¸";
let rmChart = null;
let logs = loadRecords();

// ==============================
// ãƒ•ã‚©ãƒ¼ãƒ ç”¨ ç¨®ç›®ã‚»ãƒ¬ã‚¯ãƒˆæç”»
// ==============================
function renderExerciseOptionsForForm() {
  const select = /** @type {HTMLSelectElement} */ (exerciseSelect);
  if (!select) return;

  select.innerHTML = "";
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "ç¨®ç›®ã‚’é¸æŠ";
  select.appendChild(placeholder);

  const defaults = DEFAULT_EXERCISES[currentBodyPart] || [];
  const customs = getCustomExercisesFor(currentBodyPart);
  const all = [...defaults, ...customs];

  all.forEach((name) => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });

  updateFieldVisibilityByExercise(select.value);
}

function updateFieldVisibilityByExercise(exName) {
  const cardio = isCardioExercise(exName);

  strengthFields.forEach((el) => {
    el.style.display = cardio ? "none" : "";
  });

  cardioFields.forEach((el) => {
    el.style.display = cardio ? "" : "none";
  });
}

// ==============================
// ä¸€è¦§ãƒ»ã‚°ãƒ©ãƒ•ãªã©ã®å†æç”»
// ==============================
function renderAll() {
  renderList();
  updateExerciseOptionsForGraph();
  updateTrainingDateOptions();

  const ex = /** @type {HTMLSelectElement} */ (exerciseSelectForGraph).value;
  const range = /** @type {HTMLSelectElement} */ (rangeSelect).value;

  if (ex && !isCardioExercise(ex)) {
    updateRmChart(ex, range);
    renderStats(ex, range);
    renderHistory(ex, range);
  } else {
    if (rmChart) {
      rmChart.destroy();
      rmChart = null;
    }
    statsDiv.textContent = "ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    historyDiv.textContent = "ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
  }

  const selectedDate = /** @type {HTMLSelectElement} */ (
    dateSessionSelect
  ).value;
  if (selectedDate) {
    renderSessionByDate(selectedDate);
  } else {
    dateSessionSummary.textContent = "è¨˜éŒ²ãŒã‚ã‚‹æ—¥ä»˜ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚";
  }
}

function renderList() {
  list.innerHTML = "";

  const sorted = logs.slice().sort((a, b) => {
    if (a.date === b.date) return (a.setNo || 0) - (b.setNo || 0);
    return a.date.localeCompare(b.date);
  });

  sorted.forEach((log) => {
    const li = document.createElement("li");

    const main = document.createElement("span");
    main.className = "log-main-text";

    let text;
    if (isCardioExercise(log.exercise)) {
      const parts = [];
      if (log.distance) parts.push(`${log.distance}km`);
      if (log.duration) parts.push(`${log.duration}åˆ†`);
      if (log.speed) parts.push(`${log.speed}`);
      text = `${log.date} / ${log.exercise} / ${parts.join(" / ")}`;
    } else {
      text = `${log.date} / ${log.exercise} / ${log.setNo}ã‚»ãƒƒãƒˆç›® / ${log.weight}kg Ã— ${log.reps}å›`;
      if (log.rpe) {
        text += ` (RPE ${log.rpe})`;
      }
    }

    if (log.bodyWeight != null) {
      text += ` / ä½“é‡ ${log.bodyWeight}kg`;
    }
    if (log.memo) {
      text += ` - ${log.memo}`;
    }
    main.textContent = text;

    const hint = document.createElement("span");
    hint.className = "log-delete-hint";
    hint.textContent = "ã‚¿ãƒƒãƒ—ã§å‰Šé™¤";

    li.appendChild(main);
    li.appendChild(hint);

    li.addEventListener("click", () => {
      if (confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        const originalIndex = logs.findIndex(
          (l) =>
            l.date === log.date &&
            l.exercise === log.exercise &&
            l.setNo === log.setNo &&
            l.weight === log.weight &&
            l.reps === log.reps &&
            l.rpe === log.rpe &&
            l.memo === log.memo &&
            (l.bodyWeight ?? null) === (log.bodyWeight ?? null) &&
            (l.distance ?? null) === (log.distance ?? null) &&
            (l.duration ?? null) === (log.duration ?? null) &&
            (l.speed ?? null) === (log.speed ?? null),
        );
        if (originalIndex !== -1) {
          logs.splice(originalIndex, 1);
          saveLogsToLocal(logs);
          renderAll();
        }
      }
    });

    list.appendChild(li);
  });
}

function updateExerciseOptionsForGraph() {
  const exercises = [
    ...new Set(
      logs
        .filter((log) => !isCardioExercise(log.exercise))
        .map((log) => log.exercise)
        .filter((name) => !!name),
    ),
  ];

  const current = /** @type {HTMLSelectElement} */ (
    exerciseSelectForGraph
  ).value;
  exerciseSelectForGraph.innerHTML = "";

  if (exercises.length === 0) {
    const option = document.createElement("option");
    option.value = "";
    option.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
    exerciseSelectForGraph.appendChild(option);
    return;
  }

  exercises.forEach((name) => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    exerciseSelectForGraph.appendChild(option);
  });

  if (current && exercises.includes(current)) {
    exerciseSelectForGraph.value = current;
  } else if (!exerciseSelectForGraph.value && exercises.length > 0) {
    exerciseSelectForGraph.value = exercises[0];
  }
}

function updateTrainingDateOptions() {
  const dates = [
    ...new Set(logs.map((log) => log.date).filter((d) => !!d)),
  ].sort((a, b) => b.localeCompare(a));

  const selectEl = /** @type {HTMLSelectElement} */ (dateSessionSelect);
  const current = selectEl.value;

  selectEl.innerHTML = "";
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = dates.length ? "æ—¥ä»˜ã‚’é¸æŠ" : "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
  selectEl.appendChild(placeholder);

  dates.forEach((d) => {
    const option = document.createElement("option");
    option.value = d;
    option.textContent = d;
    selectEl.appendChild(option);
  });

  if (current && dates.includes(current)) {
    selectEl.value = current;
  } else if (!current && dates.length > 0) {
    selectEl.value = dates[0];
  }
}

function updateRmChart(exerciseName, rangeValue) {
  if (!exerciseName || isCardioExercise(exerciseName)) return;

  const sessions = getExerciseSessions(exerciseName, rangeValue);
  const logsForChart = sessions.flatMap((s) =>
    s.sets.map((set) => ({
      label: `${s.date} (${set.setNo}ã‚»ãƒƒãƒˆç›®)`,
      rm: estimate1RM(set.weight, set.reps),
    })),
  );

  const labels = logsForChart.map((x) => x.label);
  const data = logsForChart.map((x) => x.rm);

  const ctx = document.getElementById("rmChart").getContext("2d");

  if (rmChart) {
    rmChart.destroy();
  }

  rmChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: `${exerciseName} ã®æ¨å®š 1RM`,
          data,
          tension: 0.2,
          pointRadius: 3,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: {
            boxWidth: 16,
          },
        },
      },
      scales: {
        y: {
          title: {
            display: true,
            text: "æ¨å®š 1RM (kg)",
          },
        },
        x: {
          title: {
            display: true,
            text: "æ—¥ä»˜ / ã‚»ãƒƒãƒˆ",
          },
        },
      },
    },
  });
}

function renderStats(exerciseName, rangeValue) {
  statsDiv.innerHTML = "";

  if (!exerciseName || isCardioExercise(exerciseName)) {
    statsDiv.textContent = "ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    return;
  }

  const sessions = getExerciseSessions(exerciseName, rangeValue);
  if (sessions.length === 0) {
    statsDiv.textContent = "é¸æŠä¸­ã®æœŸé–“ã«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  const max1RM = Math.max(...sessions.map((s) => s.top1RM));
  const avg1RM =
    Math.round(
      (sessions.reduce((sum, s) => sum + s.top1RM, 0) / sessions.length) * 10,
    ) / 10;

  const avgVolume = Math.round(
    sessions.reduce((sum, s) => sum + s.volume, 0) / sessions.length,
  );

  const p1 = document.createElement("p");
  p1.textContent = `æœ€å¤§ 1RMï¼š${max1RM} kg`;

  const p2 = document.createElement("p");
  p2.textContent = `å¹³å‡ 1RMï¼ˆãƒˆãƒƒãƒ—ã‚»ãƒƒãƒˆï¼‰ï¼š${avg1RM} kg`;

  const p3 = document.createElement("p");
  p3.textContent = `å¹³å‡ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆ1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šï¼‰ï¼š${avgVolume} kgÃ—rep`;

  statsDiv.appendChild(p1);
  statsDiv.appendChild(p2);
  statsDiv.appendChild(p3);
}

function formatDiff(value, unit) {
  if (value > 0) return `+${value}${unit}`;
  if (value < 0) return `${value}${unit}`;
  return `Â±0${unit}`;
}

function renderHistory(exerciseName, rangeValue) {
  historyDiv.innerHTML = "";

  if (!exerciseName || isCardioExercise(exerciseName)) {
    historyDiv.textContent = "ç¨®ç›®ã‚’é¸æŠã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
    return;
  }

  const sessions = getExerciseSessions(exerciseName, rangeValue);
  if (sessions.length === 0) {
    historyDiv.textContent = "ã“ã®æœŸé–“ã«ã¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  let shown = 0;
  for (let i = sessions.length - 1; i >= 0 && shown < 3; i--, shown++) {
    const s = sessions[i];
    const prev = i > 0 ? sessions[i - 1] : null;

    const title = document.createElement("h3");
    title.textContent = s.date;
    historyDiv.appendChild(title);

    const ul = document.createElement("ul");
    s.sets.forEach((log) => {
      let text = `${log.setNo}ã‚»ãƒƒãƒˆç›®: ${log.weight}kg Ã— ${log.reps}å›`;
      if (log.rpe) text += ` (RPE ${log.rpe})`;
      if (log.memo) text += ` - ${log.memo}`;
      const li = document.createElement("li");
      li.textContent = text;
      ul.appendChild(li);
    });
    historyDiv.appendChild(ul);

    const p = document.createElement("p");
    if (prev) {
      const diffW = s.topSet.weight - prev.topSet.weight;
      const diffR = s.topSet.reps - prev.topSet.reps;
      const diffRM = Math.round((s.top1RM - prev.top1RM) * 10) / 10;
      const diffVol = s.volume - prev.volume;

      p.textContent =
        `å‰å›æ¯”ï¼ˆãƒˆãƒƒãƒ—ã‚»ãƒƒãƒˆåŸºæº–ï¼‰: ` +
        `é‡é‡ ${formatDiff(diffW, "kg")} / ` +
        `å›æ•° ${formatDiff(diffR, "å›")} / ` +
        `1RM ${formatDiff(diffRM, "kg")} / ` +
        `ãƒœãƒªãƒ¥ãƒ¼ãƒ  ${formatDiff(diffVol, "kgÃ—rep")}`;
    } else {
      p.textContent = "ã“ã®ç¨®ç›®ã®åˆå›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚";
    }
    historyDiv.appendChild(p);
  }
}

function renderSessionByDate(dateStr) {
  dateSessionSummary.innerHTML = "";
  if (!dateStr) {
    dateSessionSummary.textContent = "è¨˜éŒ²ãŒã‚ã‚‹æ—¥ä»˜ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  const logsForDate = logs
    .filter((l) => l.date === dateStr)
    .sort((a, b) => {
      if (a.exercise === b.exercise) return (a.setNo || 0) - (b.setNo || 0);
      return a.exercise.localeCompare(b.exercise);
    });

  if (logsForDate.length === 0) {
    dateSessionSummary.textContent = "ã“ã®æ—¥ä»˜ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  const bwLog = logsForDate.find((l) => l.bodyWeight != null);
  if (bwLog && bwLog.bodyWeight != null) {
    const pBw = document.createElement("p");
    pBw.textContent = `ä½“é‡: ${bwLog.bodyWeight} kg`;
    dateSessionSummary.appendChild(pBw);
  }

  const map = /** @type {Record<string, TrainingLog[]>} */ ({});
  logsForDate.forEach((log) => {
    if (!map[log.exercise]) map[log.exercise] = [];
    map[log.exercise].push(log);
  });

  Object.keys(map)
    .sort()
    .forEach((exercise) => {
      const h3 = document.createElement("h3");
      h3.textContent = exercise;
      dateSessionSummary.appendChild(h3);

      const ul = document.createElement("ul");
      const isCardio = isCardioExercise(exercise);

      map[exercise]
        .slice()
        .sort((a, b) => (a.setNo || 0) - (b.setNo || 0))
        .forEach((log) => {
          let text;
          if (isCardio) {
            const parts = [];
            if (log.distance) parts.push(`${log.distance}km`);
            if (log.duration) parts.push(`${log.duration}åˆ†`);
            if (log.speed) parts.push(`${log.speed}`);
            text = parts.join(" / ");
          } else {
            text = `${log.setNo}ã‚»ãƒƒãƒˆç›®: ${log.weight}kg Ã— ${log.reps}å›`;
            if (log.rpe) text += ` (RPE ${log.rpe})`;
          }
          if (log.memo) text += ` - ${log.memo}`;
          const li = document.createElement("li");
          li.textContent = text;
          ul.appendChild(li);
        });
      dateSessionSummary.appendChild(ul);
    });
}

// ==============================
// Firestore é€£æº
// ==============================
async function saveLogToCloud(log) {
  try {
    await addDoc(collection(db, "trainingLogs"), log);
    console.log("ğŸ”¥ Firestore ã«ä¿å­˜æˆåŠŸ:", log);
  } catch (e) {
    console.error("âŒ Firestore ä¿å­˜å¤±æ•—:", e);
  }
}

async function loadLogsFromCloud() {
  try {
    const querySnapshot = await getDocs(collection(db, "trainingLogs"));
    const loadedLogs = querySnapshot.docs.map((doc) => doc.data());
    console.log("âœ… Firestore ã‹ã‚‰èª­ã¿è¾¼ã¿æˆåŠŸ:", loadedLogs);
    return loadedLogs;
  } catch (e) {
    console.error("âŒ Firestore èª­ã¿è¾¼ã¿å¤±æ•—:", e);
    return [];
  }
}

// ==============================
// ã‚¤ãƒ™ãƒ³ãƒˆ: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
// ==============================
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const date = /** @type {HTMLInputElement} */ (
    document.getElementById("date")
  ).value;
  const bodyWeightRaw = /** @type {HTMLInputElement} */ (
    document.getElementById("bodyWeight")
  ).value;
  const exercise = /** @type {HTMLSelectElement} */ (
    document.getElementById("exercise")
  ).value;

  const isCardio = isCardioExercise(exercise);

  const memo = /** @type {HTMLInputElement} */ (
    document.getElementById("memo")
  ).value;
  const bodyWeight = bodyWeightRaw ? Number(bodyWeightRaw) : null;

  let setNo = 1;
  let weight = 0;
  let reps = 0;
  let rpe = null;
  let distance = null;
  let duration = null;
  let speed = null;

  if (isCardio) {
    distance = Number(
      /** @type {HTMLInputElement} */ (document.getElementById("distance"))
        .value || 0,
    );
    duration = Number(
      /** @type {HTMLInputElement} */ (document.getElementById("duration"))
        .value || 0,
    );
    speed = /** @type {HTMLInputElement} */ (
      document.getElementById("speed")
    ).value;

    if (!date || !exercise || (!distance && !duration)) {
      alert("æ—¥ä»˜ãƒ»ç¨®ç›®ãƒ»è·é›¢ã¾ãŸã¯æ™‚é–“ã¯å¿…é ˆã§ã™ã€‚");
      return;
    }
  } else {
    setNo =
      Number(
        /** @type {HTMLInputElement} */ (
          document.getElementById("setNo")
        ).value,
      ) || 1;
    weight = Number(
      /** @type {HTMLInputElement} */ (document.getElementById("weight")).value,
    );
    reps = Number(
      /** @type {HTMLInputElement} */ (document.getElementById("reps")).value,
    );
    rpe = /** @type {HTMLInputElement} */ (
      document.getElementById("rpe")
    ).value;

    if (!date || !exercise || !weight || !reps) {
      alert("æ—¥ä»˜ãƒ»ç¨®ç›®ãƒ»é‡é‡ãƒ»å›æ•°ã¯å¿…é ˆã§ã™ã€‚");
      return;
    }
  }

  /** @type {TrainingLog} */
  const newLog = {
    date,
    bodyWeight,
    exercise,
    setNo,
    weight,
    reps,
    rpe: rpe || null,
    memo: memo || "",
    distance,
    duration,
    speed: speed || null,
  };

  logs.push(newLog);
  saveLogsToLocal(logs);
  saveLogToCloud(newLog);
  sendLogToSheet(newLog);

  const setNoInput = /** @type {HTMLInputElement} */ (
    document.getElementById("setNo")
  );
  setNoInput.value = String(setNo + 1);

  // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
  /** @type {HTMLInputElement} */ (document.getElementById("weight")).value =
    "";
  /** @type {HTMLInputElement} */ (document.getElementById("reps")).value =
    "";
  /** @type {HTMLInputElement} */ (document.getElementById("rpe")).value =
    "";
  /** @type {HTMLInputElement} */ (
    document.getElementById("distance")
  ).value = "";
  /** @type {HTMLInputElement} */ (
    document.getElementById("duration")
  ).value = "";
  /** @type {HTMLInputElement} */ (document.getElementById("speed")).value =
    "";
  /** @type {HTMLInputElement} */ (document.getElementById("memo")).value =
    "";

  renderAll();
});

// ==============================
// ã‚¤ãƒ™ãƒ³ãƒˆ: ãƒœã‚¿ãƒ³é¡
// ==============================
if (todayBtn) {
  todayBtn.addEventListener("click", () => {
    const dateInput = /** @type {HTMLInputElement} */ (
      document.getElementById("date")
    );
    dateInput.value = getTodayString();
  });
}

if (copyFirstSetBtn) {
  copyFirstSetBtn.addEventListener("click", () => {
    const dateInput = /** @type {HTMLInputElement} */ (
      document.getElementById("date")
    );
    const exerciseInput = /** @type {HTMLSelectElement} */ (
      document.getElementById("exercise")
    );
    const setNoInput = /** @type {HTMLInputElement} */ (
      document.getElementById("setNo")
    );
    const weightInput = /** @type {HTMLInputElement} */ (
      document.getElementById("weight")
    );
    const repsInput = /** @type {HTMLInputElement} */ (
      document.getElementById("reps")
    );
    const rpeInput = /** @type {HTMLInputElement} */ (
      document.getElementById("rpe")
    );
    const memoInput = /** @type {HTMLInputElement} */ (
      document.getElementById("memo")
    );
    const bwInput = /** @type {HTMLInputElement} */ (
      document.getElementById("bodyWeight")
    );

    const date = dateInput.value;
    const exercise = exerciseInput.value;

    if (isCardioExercise(exercise)) {
      alert("æœ‰é…¸ç´ ç¨®ç›®ã§ã¯ 1 ã‚»ãƒƒãƒˆç›®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚");
      return;
    }

    if (!date || !exercise) {
      alert("å…ˆã«æ—¥ä»˜ã¨ç¨®ç›®ã‚’é¸æŠã—ã€1ã‚»ãƒƒãƒˆç›®ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const sameLogs = logs.filter(
      (l) => l.date === date && l.exercise === exercise,
    );
    if (sameLogs.length === 0) {
      alert("ã“ã®æ—¥ä»˜ãƒ»ç¨®ç›®ã®è¨˜éŒ²ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãš 1 ã‚»ãƒƒãƒˆç›®ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const firstSet =
      sameLogs.find((l) => l.setNo === 1) ||
      sameLogs.reduce((min, l) => (l.setNo < min.setNo ? l : min), sameLogs[0]);

    const nextSetNo =
      sameLogs.reduce((max, l) => Math.max(max, l.setNo || 0), 0) + 1;

    setNoInput.value = String(nextSetNo);
    weightInput.value = String(firstSet.weight ?? "");
    repsInput.value = String(firstSet.reps ?? "");
    rpeInput.value = firstSet.rpe ?? "";
    memoInput.value = firstSet.memo ?? "";
    if (firstSet.bodyWeight != null) {
      bwInput.value = String(firstSet.bodyWeight);
    }
  });
}

if (addCustomExBtn && customExInput && exerciseSelect) {
  addCustomExBtn.addEventListener("click", () => {
    const input = /** @type {HTMLInputElement} */ (customExInput);
    const select = /** @type {HTMLSelectElement} */ (exerciseSelect);
    const name = input.value.trim();
    if (!name) {
      alert("æ–°ã—ã„ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const existing = getAllExerciseNames();
    if (existing.includes(name)) {
      alert("ãã®ç¨®ç›®ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚");
      select.value = name;
      input.value = "";
      updateFieldVisibilityByExercise(name);
      return;
    }

    const stored = loadCustomExercises();
    stored.push({ name, bodyPart: currentBodyPart });
    saveCustomExercises(stored);

    renderExerciseOptionsForForm();
    select.value = name;
    input.value = "";
    updateFieldVisibilityByExercise(name);
  });
}

bodyPartButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    const bodyPart = btn.getAttribute("data-body-part");
    if (!bodyPart) return;
    currentBodyPart = bodyPart;

    bodyPartButtons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");

    renderExerciseOptionsForForm();
  });
});

rangeSelect.addEventListener("change", () => {
  const ex = /** @type {HTMLSelectElement} */ (exerciseSelectForGraph).value;
  const range = /** @type {HTMLSelectElement} */ (rangeSelect).value;
  if (ex && !isCardioExercise(ex)) {
    updateRmChart(ex, range);
    renderStats(ex, range);
    renderHistory(ex, range);
  }
});

if (dateSessionSelect) {
  dateSessionSelect.addEventListener("change", () => {
    const selected = /** @type {HTMLSelectElement} */ (
      dateSessionSelect
    ).value;
    renderSessionByDate(selected);
  });
}

// ç¨®ç›®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ã«ç­‹ãƒˆãƒ¬ï¼æœ‰é…¸ç´ ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
if (exerciseSelect) {
  exerciseSelect.addEventListener("change", (e) => {
    const name = /** @type {HTMLSelectElement} */ (e.target).value;
    updateFieldVisibilityByExercise(name);
  });
}

// ==============================
// åˆæœŸè¡¨ç¤º
// ==============================
(async () => {
  setDefaultDate();
  renderExerciseOptionsForForm();

  const cloudLogs = await loadLogsFromCloud();
  if (cloudLogs.length > 0) {
    logs = cloudLogs;
    saveLogsToLocal(logs);
    console.log(`ğŸ”¥ ${cloudLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’ Firestore ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  } else {
    console.log("â„¹ï¸ Firestore ã«ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿è¡¨ç¤ºï¼‰");
  }

  renderAll();
})();
```
